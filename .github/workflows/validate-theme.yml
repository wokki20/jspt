name: Theme Submission Validation

on:
  pull_request:
    branches:
      - gh-pages
    paths:
      - 'themes_list.json'
    types: [opened, synchronize, edited]

permissions:
  contents: read

jobs:
  validate-submission:
    runs-on: ubuntu-latest
    name: Validate Theme Submission
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Checkout base branch
        run: |
          git fetch origin ${{ github.base_ref }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install -g ajv-cli node-fetch
        
      - name: Run validation script
        id: validate
        continue-on-error: true
        run: |
          node .github/scripts/validate-theme.js
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BODY: ${{ github.event.pull_request.body }}
          BASE_REF: ${{ github.base_ref }}
          HEAD_REF: ${{ github.head_ref }}
          REPO: ${{ github.repository }}
          
      - name: Save validation results
        if: always()
        run: |
          mkdir -p validation-results
          
          # Save PR metadata
          echo "${{ github.event.pull_request.number }}" > validation-results/pr-number.txt
          echo "${{ github.event.pull_request.head.sha }}" > validation-results/pr-sha.txt
          echo "${{ github.repository }}" > validation-results/repo.txt
          
          # Save validation results if they exist
          if [ -f /tmp/validation-errors.txt ]; then
            cp /tmp/validation-errors.txt validation-results/
          fi
          
          if [ -f /tmp/validation-success.txt ]; then
            cp /tmp/validation-success.txt validation-results/
          fi
          
          # Save the exit status
          echo "${{ steps.validate.outcome }}" > validation-results/outcome.txt
          
      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: validation-results/
          retention-days: 1

  validate-pr-template:
    runs-on: ubuntu-latest
    name: Validate PR Template
    
    steps:
      - name: Check PR body
        id: check
        continue-on-error: true
        run: |
          cat > check-template.js << 'EOFJS'
          const prBody = process.env.PR_BODY || '';
          const errors = [];
          
          const requiredFields = [
            { name: 'Theme Name', pattern: /\*\*Theme Name:\*\*\s*(.+)/ },
            { name: 'Display Name', pattern: /\*\*Display Name:\*\*\s*(.+)/ },
            { name: 'Author', pattern: /\*\*Author:\*\*\s*(.+)/ },
            { name: 'Version', pattern: /\*\*Version:\*\*\s*(.+)/ },
            { name: 'GitHub Repository', pattern: /\*\*GitHub Repository:\*\*\s*(https:\/\/github\.com\/.+)/ },
            { name: 'Homepage URL', pattern: /\*\*Homepage URL:\*\*\s*(https?:\/\/.+)/ },
            { name: 'Theme URL', pattern: /\*\*Theme URL \(direct CSS link\):\*\*\s*(https?:\/\/.+\.css)/ },
            { name: 'Theme Config URL', pattern: /\*\*Theme Config URL:\*\*\s*(https?:\/\/.+\.json)/ }
          ];
          
          for (const field of requiredFields) {
            const match = prBody.match(field.pattern);
            if (!match || match[1].trim().includes('<!--') || match[1].trim() === '') {
              errors.push(`- ❌ ${field.name} is missing or not filled out`);
            }
          }
          
          const checklist = [
            'I have read and followed the',
            'My theme is publicly hosted',
            'The `theme_config.json` file is properly formatted',
            'My theme is hosted on a public GitHub repository',
            'I have tested the theme',
            'The theme URL points directly to the CSS file',
            'My theme follows accessibility best practices',
            'I have added my theme to `themes_list.json` correctly',
            'The `themes_list.json` file is valid JSON'
          ];
          
          let uncheckedItems = 0;
          for (const item of checklist) {
            const regex = new RegExp(`- \\[ \\].*${item.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`);
            if (regex.test(prBody)) {
              uncheckedItems++;
            }
          }
          
          if (uncheckedItems > 0) {
            errors.push(`- ❌ ${uncheckedItems} checklist item(s) not checked`);
          }
          
          if (!prBody.match(/- \[x\]/i)) {
            errors.push('- ❌ No checklist items are checked');
          }
          
          const categoryRegex = /- \[x\]/gi;
          const categoryMatches = prBody.match(categoryRegex);
          if (!categoryMatches || categoryMatches.length < 2) {
            errors.push('- ⚠️ No categories selected (at least one recommended)');
          }
          
          const fs = require('fs');
          fs.mkdirSync('template-results', { recursive: true });
          
          if (errors.length > 0) {
            const comment = `## ❌ PR Template Validation Failed\n\n${errors.join('\n')}\n\n---\n*Please complete all required fields and check all boxes in the PR template.*`;
            fs.writeFileSync('template-results/template-errors.txt', comment);
            process.exit(1);
          } else {
            fs.writeFileSync('template-results/template-success.txt', '✅ PR template validation passed!');
          }
          EOFJS
          
          node check-template.js
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          
      - name: Save template validation results
        if: always()
        run: |
          if [ ! -d template-results ]; then
            mkdir -p template-results
          fi
          
          echo "${{ github.event.pull_request.number }}" > template-results/pr-number.txt
          echo "${{ github.event.pull_request.head.sha }}" > template-results/pr-sha.txt
          echo "${{ github.repository }}" > template-results/repo.txt
          echo "${{ steps.check.outcome }}" > template-results/outcome.txt
          
      - name: Upload template results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: template-results
          path: template-results/
          retention-days: 1