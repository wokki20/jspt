name: Post Validation Results

on:
  workflow_run:
    workflows: ["Theme Submission Validation"]
    types:
      - completed

permissions:
  contents: read
  issues: write
  pull-requests: write
  statuses: write

jobs:
  post-results:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion != 'skipped'
    
    steps:
      - name: Download validation artifacts
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          path: artifacts
          
      - name: Process validation results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let prNumber, prSha, repo;
            
            if (fs.existsSync('artifacts/validation-results/pr-number.txt')) {
              prNumber = fs.readFileSync('artifacts/validation-results/pr-number.txt', 'utf8').trim();
              prSha = fs.readFileSync('artifacts/validation-results/pr-sha.txt', 'utf8').trim();
              repo = fs.readFileSync('artifacts/validation-results/repo.txt', 'utf8').trim();
            } else if (fs.existsSync('artifacts/template-results/pr-number.txt')) {
              prNumber = fs.readFileSync('artifacts/template-results/pr-number.txt', 'utf8').trim();
              prSha = fs.readFileSync('artifacts/template-results/pr-sha.txt', 'utf8').trim();
              repo = fs.readFileSync('artifacts/template-results/repo.txt', 'utf8').trim();
            } else {
              console.log('No PR metadata found, skipping...');
              return;
            }
            
            console.log(`Processing PR #${prNumber}`);
            
            if (fs.existsSync('artifacts/validation-results')) {
              const outcome = fs.readFileSync('artifacts/validation-results/outcome.txt', 'utf8').trim();
              
              if (outcome === 'failure') {
                let comment = '## ❌ Theme Submission Validation Failed\n\n';
                
                if (fs.existsSync('artifacts/validation-results/validation-errors.txt')) {
                  const errors = fs.readFileSync('artifacts/validation-results/validation-errors.txt', 'utf8');
                  comment += errors;
                } else {
                  comment += 'Unknown validation error occurred.';
                }
                
                comment += '\n\n---\n*Please fix these issues and update your PR.*';
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNumber),
                  body: comment
                });
                
                await github.rest.repos.createCommitStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  sha: prSha,
                  state: 'failure',
                  context: 'Theme Validation',
                  description: 'Validation checks failed. See comments for details.'
                });
              } else if (outcome === 'success') {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNumber),
                  body: '## ✅ Theme Submission Validation Passed\n\nAll validation checks passed successfully!'
                });
                
                await github.rest.repos.createCommitStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  sha: prSha,
                  state: 'success',
                  context: 'Theme Validation',
                  description: 'All validation checks passed!'
                });
              }
            }
            
            if (fs.existsSync('artifacts/template-results')) {
              const outcome = fs.readFileSync('artifacts/template-results/outcome.txt', 'utf8').trim();
              
              if (outcome === 'failure' && fs.existsSync('artifacts/template-results/template-errors.txt')) {
                const comment = fs.readFileSync('artifacts/template-results/template-errors.txt', 'utf8');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNumber),
                  body: comment
                });
              } else if (outcome === 'success' && fs.existsSync('artifacts/template-results/template-success.txt')) {
                const comment = fs.readFileSync('artifacts/template-results/template-success.txt', 'utf8');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNumber),
                  body: comment
                });
              }
            }